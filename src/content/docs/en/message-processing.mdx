---
title: "Message Processing"
description: "How messages are processed to build up a shared state in Shelter Protocol"
---
import spmessageRef from './images/SPMessage.svg'

Message processing begins either when clients receive an [`SPMessage`](spmessage) over [the WebSocket](server-api#server-entry), or by calling one of the RESTful APIs like [`/eventsAfter`](server-api#eventsafter) and processing the list of events the server sends back.

The events in a contract chain are processed in the order they appear in the contract, to build up a consistent shared state across clients (although in some cases, [it is possible for clients to arrive at slightly different state](#inconsistent-state)).

<img src={spmessageRef} alt="Simple diagram showing two SPMessages, the first OP_CONTRACT, the next, OP_ACTION_ENCRYPTED" class="center" />

A contract chain is instantiated using [`OP_CONTRACT`](opcodes#op_contract). From that point on, [other opcodes](opcodes) are added in an append-only manner, and processed in turn.

### Client-side Processing

Message processing consists of the following steps on the client:

1. Verifies it is expecting this message (because it's part of a contract that it [subscribed to](server-api#client-sub)).
2. (Optionally) stores a copy of the message to its local key-value database.
3. Temporarily saves a copy of the entire local contract state (in case the next steps fail).
4. Processes the message [opcode](opcodes), modifying local contract state as needed.
  - If this step fails, it reverts all mutations using the state that was saved in (3), emits errors as needed, skips further steps, and continues processing any other messages.
5. Executes any contract side effects.
  - If there are any errors during side effect execution, inform the user's code and proceed with processing further messages.

> âš ï¸Ž During the **processing** step, contracts can only access state that comes from the contract itself, or the data that is passed in along with the opcode. The boundary between a contract and the rest of the application occurs in **side effects**.

### Side effects



### Inconsistent State

In some circumstances it is possible for different clients to build up a different state for the same contract than other clients.

Specifically, this can happen when messages sent using [`OP_ACTION_ENCRYPTED`](opcodes#op_action_encrypted) are encrypted using keys that **Client A** has, but **Client B** does not have. In that case, **Client A** will be able to decrypt and process the message, but **Client B** will not.

### Contract & VM State

Special keys begin with a `_`, these are managed by Shelter Protocol implementations and are not set by developers. Two special keys defined by the protocol are:

- `_vm` â€”
- `_volatile` â€” not stored in snapshots.

TODO/TBD: specify how secret keys are handled in snapshots.

### Sandbox


### Server-side Processing

Because the server is only interested in ensuring that authorized parties are allowed to write to contracts, the server processes all opcodes except for [`OP_ACTION_ENCRYPTED`](opcodes#op_action_encrypted) and [`OP_ACTION_UNENCRYPTED`](opcodes#op_action_unencrypted).

ðŸš§ This section is under construction. ðŸš§