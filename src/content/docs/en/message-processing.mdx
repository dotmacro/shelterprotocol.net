---
title: "Message Processing"
description: "How messages are processed to build up a shared state in Shelter Protocol"
---
import spmessageRef from './images/SPMessage.svg'

Message processing begins when clients subscribe to a `contractID` by calling [`/eventsAfter`](server-api#eventsafter). This results in a list of ordered events being sent back to the client for processing.

The events in a contract chain are processed in the order they appear in the contract, to build up a consistent shared state across clients (although in some cases, [it is possible for clients to arrive at slightly different state](#inconsistent-state)).

<img src={spmessageRef} alt="Simple diagram showing two SPMessages, the first OP_CONTRACT, the next, OP_ACTION_ENCRYPTED" class="center" />

A contract chain is instantiated using [`OP_CONTRACT`](opcodes#op_contract). From that point on, [other opcodes](opcodes) are added in an append-only manner, and processed in turn.

Message processing consists of the following steps:

1. 
2. 
3. 

> ⚠︎ During the **processing** step, contracts can only access state that comes from the contract itself, or the data that is passed in along with the opcode. The boundary between a contract and the rest of the application occurs in **side effects**.

### Side effects



### Inconsistent State

In some circumstances it is possible for different clients to build up a different state for the same contract than other clients.

Specifically, this can happen when messages sent using [`OP_ACTION_ENCRYPTED`](opcodes#op_action_encrypted) are encrypted using keys that **Client A** has, but **Client B** does not have. In that case, **Client A** will be able to decrypt and process the message, but **Client B** will not.

### Contract & VM State

Special keys begin with a `_`, these are managed by Shelter Protocol implementations and are not set by developers. Two special keys defined by the protocol are:

- `_vm` —
- `_volatile` — not stored in snapshots.

TODO/TBD: specify how secret keys are handled in snapshots.

### Sandbox
